<h2 class="text-center mb-4" style="color:#052155; font-weight:700;">Data Analytics</h2>

<style>
  .chart-row {
    display: flex;
    gap: 40px;
    margin-bottom: 40px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .chart-box {
    background: #f8fbff;
    border: 1.5px solid #b6c6e3;
    border-radius: 18px;
    box-shadow: 0 4px 24px rgba(2, 33, 85, 0.08);
    padding: 32px 24px 24px 24px;
    width: 540px;
    min-width: 320px;
    min-height: 520px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 0;
    transition: box-shadow 0.2s;
    
  }
  .chart-box:hover {
    box-shadow: 0 8px 32px rgba(2, 33, 85, 0.16);
    border-color: #052155;
  }
  .chart-box strong, .chart-box select {
    font-size: 1.15rem;
    color: #052155;
    margin-bottom: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
  }
  .chart-box select {
    border-radius: 6px;
    border: 1px solid #b6c6e3;
    padding: 2px 8px;
    margin-left: 6px;
    font-size: 1rem;
    color: #052155;
    background: #f8fbff;
  }
  .chart-box canvas {
    max-width: 470px !important;
    max-height: 340px !important;
    margin-top: 10px;
  }
  @media (max-width: 1200px) {
    .chart-row {
      flex-direction: column;
      gap: 32px;
      align-items: center;
    }
    .chart-box {
      width: 98vw;
      max-width: 98vw;
      min-width: unset;
    }
    .chart-box canvas {
      max-width: 100% !important;
      height: auto !important;
    }
  }
  .info-btn {
    position: absolute;
    top: 22px;
    right: 32px;
    cursor: pointer;
    display: inline-block;
    z-index: 2;
  }
  .info-btn i {
    display: inline-block;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #e3eafc;
    color: #1976d2;
    font-style: italic; /* Make the "i" italic */
    font-weight: bold;
    text-align: center;
    line-height: 22px;
    font-size: 15px;
    border: 1.5px solid #b6c6e3;
    transition: background 0.2s;
  }
  .info-btn:hover i,
  .info-btn:focus i {
    background: #1976d2;
    color: #fff;
  }
  .info-tooltip {
    display: none;
    position: absolute;
    top: 28px;
    right: 0;
    background: #e3eafc;
    color: #052155;
    border: 1px solid #b6c6e3;
    border-radius: 18px;
    box-shadow: 0 4px 16px rgba(2,33,85,0.08);
    padding: 12px 16px;
    min-width: 350px;
    font-size: 0.98rem;
    z-index: 10;
    white-space: normal;
    text-align: justify;  
  }
  .info-btn:hover .info-tooltip,
  .info-btn:focus .info-tooltip {
    display: block;
  }
  .chart-box {
    position: relative; /* Needed for absolute positioning of info-btn */
  }
</style>

<div class="chart-row">
  <div class="chart-box">
    <strong>Administrative Status</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This pie chart shows the distribution of all projects based on their current administrative status. Each slice of the pie represents a different status category (such as Completed or Ongoing), and the size of each slice corresponds to the number of projects in that category. This helps quickly see how many projects are in each administrative state at a glance.
        </span>
    </span>
    <canvas id="adminStatusPie"></canvas>
  </div>
  <div class="chart-box">
    <strong>Projects Sanctioned Per Year</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This bar chart displays the number of projects that were sanctioned each year. Each bar represents a specific year, and its height corresponds to the total number of projects approved in that year. This visualization helps you quickly identify trends in project approvals over time, such as periods of increased or decreased project activity.
        </span>
    </span>
    <canvas id="sanctionBarChart"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Projects per Research Vertical</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This donut chart displays the distribution of projects across different research verticals. Each segment represents a specific research vertical, and its size corresponds to the number of projects in that category. This helps you quickly identify which research areas have the most or fewest projects.
        </span>
    </span>
    <canvas id="donutChartVertical"></canvas>
  </div>
  <div class="chart-box">
    <strong>Verticals per Institute</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This donut chart shows the distribution of research verticals across different institutes. Each segment represents an institute, and its size corresponds to the number of research verticals or projects associated with that institute. This helps you quickly identify which institutes are involved in the most research areas.
        </span>
    </span>
    <canvas id="donutChartInstitute"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Cost vs Institute</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This bar chart shows the total sanctioned cost (in lakhs) for each institute. Each bar represents an institute, and its height corresponds to the cumulative funding received by that institute for all its projects. This helps you compare the financial allocation across different institutes at a glance.
        </span>
    </span>
    <canvas id="costVsInstitute"></canvas>
  </div>
  <div class="chart-box">
    <strong>Cost vs Research Vertical</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This bar chart shows the total sanctioned cost (in lakhs) for each research vertical. Each bar represents a research vertical, and its height corresponds to the cumulative funding allocated to that vertical across all projects. This helps you compare the financial investment in different research areas.
        </span>
    </span>
    <canvas id="costVsVertical"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Monthly Sanctions by Vertical</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This stacked bar chart shows the number of projects sanctioned each month, grouped by research vertical. Each colored segment within a bar represents a different research vertical, allowing you to see both the total monthly sanctions and the contribution of each vertical. This helps you identify trends and patterns in project approvals across different research areas over time.
        </span>
    </span>
    <canvas id="monthlyStackedBar"></canvas>
  </div>
  <div class="chart-box">
    <strong>Project Status per FY Quarter</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This stacked bar chart displays the number of projects in each administrative status (Running, Closed, Open) for every financial year quarter. Each bar is divided into segments representing the different statuses, allowing you to track how project statuses change and compare their distribution across quarters. This helps you monitor project progress and identify trends over time.
        </span>
    </span>
    <canvas id="statusQuarterChart"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Project Status per Financial Half-Year</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This stacked bar chart displays the number of projects in each administrative status (Running, Closed, Open) for every financial half-year period. Each bar is divided into segments representing the different statuses, allowing you to track how project statuses change and compare their distribution across half-year intervals. This helps you monitor project progress and identify trends over time.
        </span>
    </span>
    <canvas id="statusHalfChart"></canvas>
  </div>
  <div class="chart-box">
    <strong>Project Status per FY</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This stacked bar chart displays the number of projects in each administrative status (Running, Closed, Open) for every financial year. Each bar is divided into segments representing the different statuses, allowing you to track how project statuses change and compare their distribution across years. This helps you monitor project progress and identify trends over time.
        </span>
    </span>
    <canvas id="statusYearChart"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Project Status Breakdown by Vertical</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This stacked bar chart shows the count of projects in each administrative status (Running or Closed) for every research vertical. Each bar represents a research vertical and is divided into segments for each status, allowing you to compare the distribution of project statuses across different research areas. This helps you quickly identify which verticals have more ongoing or completed projects.
        </span>
    </span>
    <canvas id="verticalStatusStacked"></canvas>
  </div>
  <div class="chart-box">
    <strong>Average Project Duration (Days) by Sanction Year</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This bar chart shows the average duration (in days) of projects sanctioned in each year. Each bar represents a sanction year, and its height corresponds to the average number of days taken to complete projects approved in that year. This helps you compare how project durations have changed over time and identify trends in project timelines.
        </span>
    </span>
    <canvas id="avgDurationChart"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Top PIs by Number of Projects</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This horizontal bar chart displays the principal investigators (PIs) who are leading the highest number of projects. Each bar represents a PI, and its length corresponds to the total number of projects they are involved in. This helps you quickly identify the most active researchers in terms of project leadership.
        </span>
    </span>
    <canvas id="topPIsChart"></canvas>
  </div>
  <div class="chart-box">
    <strong>Top Institutes by Number of Projects</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This horizontal bar chart displays the institutes with the highest number of projects. Each bar represents an institute, and its length corresponds to the total number of projects associated with that institute. This helps you quickly identify which institutes are most active in terms of project involvement.
        </span>
    </span>
    <canvas id="topInstitutesBar"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Projects by Funding Range</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This bar chart shows the number of projects grouped by their funding range (in lakhs). Each bar represents a specific funding range, and its height corresponds to the count of projects that fall within that range. This helps you quickly see how many projects are funded at different levels and identify trends in project funding distribution.
        </span>
    </span>
    <canvas id="fundingRangeChart"></canvas>
  </div>
  <div class="chart-box">
    <strong>Projects by Stakeholder Lab</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This pie chart shows the distribution of projects among different stakeholder labs. Each slice represents a specific lab, and its size corresponds to the number of projects that the lab is involved in. This helps you quickly see which labs are most actively participating as stakeholders across all projects.
        </span>
    </span>
    <canvas id="stakeholderLabChart"></canvas>
  </div>
</div>

<div class="chart-row">
  <div class="chart-box">
    <strong>Administrative Status Trend</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This line chart shows how the number of projects in each administrative status (such as Completed and Ongoing) has changed over the years. Each line represents a different status category, allowing you to track trends and compare the progression of project statuses over time. This helps you visualize shifts in project completion and ongoing activity across different years.
        </span>
    </span>
    <canvas id="adminStatusTrend"></canvas>
  </div>
  <div class="chart-box">
    <strong>Sanctioned Cost Trend (per Year)</strong>
    <span class="info-btn" tabindex="0">
      <i>i</i>
        <span class="info-tooltip">
          This line chart shows the total sanctioned cost (in lakhs) for projects in each year. Each point on the line represents a year, and its value corresponds to the cumulative funding approved for all projects sanctioned in that year. This helps you visualize trends and fluctuations in project funding over time.
        </span>
    </span>
    <canvas id="costTrendYearChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.3/dist/chart.umd.js"></script>

<script>
  const mainColors = [
    "#b93495", // magenta
    "#8e24aa", // deep purple
    "#5e35b1", // indigo
    "#3949ab", // royal blue
    "#1976d2", // bright blue
    "#1565c0", // cobalt blue
    "#0d47a1", // navy blue
    "#01579b", // teal blue
    "#003366", // midnight blue
    "#c25b92", // orchid
    "#B93495", // vivid magenta
    "#ba68c8", // lavender
    "#7e57c2", // amethyst
    "#64b5f6"  // sky blue
  ];
  
  const adminStatusData = {
    labels: {{ admin_status_counts.keys() | list | tojson }},
    datasets: [{
      data: {{ admin_status_counts.values() | list | tojson }},
      backgroundColor: mainColors,
    }]
  };
  new Chart(document.getElementById('adminStatusPie'), {
    type: 'pie',
    data: adminStatusData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 24, font: { size: 14 }, color: '#000000', padding: 18 } } }
    }
  });

  // Bar Chart: Projects Sanctioned Per Year
  const barChartData = {
    labels: {{ year_labels | default([]) | tojson }},
    datasets: [{
      label: 'Projects Sanctioned',
      data: {{ year_values | default([]) | tojson }},
      backgroundColor: mainColors,
    }]
  };
  new Chart(document.getElementById('sanctionBarChart'), {
    type: 'bar',
    data: barChartData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
    }
  });

  // Donut Chart: Projects per Research Vertical
  const verticalLabels = {{ vertical_counts.keys() | default([]) | list | tojson }};
  const verticalData = {{ vertical_counts.values() | default([]) | list | tojson }};
  new Chart(document.getElementById('donutChartVertical'), {
    type: 'doughnut',
    data: {
      labels: verticalLabels,
      datasets: [{
        data: verticalData,
        backgroundColor: mainColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 24, font: { size: 12 }, color: '#000000', padding: 16 } } }
    }
  });

  // Donut Chart: Verticals per Institute
  const instituteLabels = {{ institute_vertical_counts.keys() | default([]) | list | tojson }};
  const instituteData = {{ institute_vertical_counts.values() | default([]) | list | tojson }};
  new Chart(document.getElementById('donutChartInstitute'), {
    type: 'doughnut',
    data: {
      labels: instituteLabels,
      datasets: [{
        data: instituteData,
        backgroundColor: mainColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '60%',
      plugins: { legend: { position: 'bottom', labels: { boxWidth: 30, font: { size: 14 }, color: '#000', padding: 17 } } }
    }
  });

  // Cost vs Institute Histogram
  const costInstituteLabels = {{ cost_institute_labels | default([]) | tojson }};
  const costInstituteValues = {{ cost_institute_values | default([]) | tojson }};
  new Chart(document.getElementById('costVsInstitute'), {
    type: 'bar',
    data: {
      labels: costInstituteLabels,
      datasets: [{
        label: 'Total Cost (Lakhs)',
        data: costInstituteValues,
        backgroundColor: mainColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Institute' }, ticks: { autoSkip: false, maxRotation: 50, minRotation: 40 } },
        y: { beginAtZero: true, title: { display: true, text: 'Cost (Lakhs)' } }
      }
    }
  });

  // Cost vs Research Vertical Histogram
  const costVerticalLabels = {{ cost_vertical_labels | default([]) | tojson }};
  const costVerticalValues = {{ cost_vertical_values | default([]) | tojson }};
  new Chart(document.getElementById('costVsVertical'), {
    type: 'bar',
    data: {
      labels: costVerticalLabels,
      datasets: [{
        label: 'Total Cost (Lakhs)',
        data: costVerticalValues,
        backgroundColor: mainColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { title: { display: true, text: 'Research Vertical' }, ticks: { autoSkip: false, maxRotation: 60, minRotation: 30 } },
        y: { beginAtZero: true, title: { display: true, text: 'Cost (Lakhs)' } }
      }
    }
  });

  // Monthly Sanctions by Vertical (Stacked Bar)
  const stackedLabels = {{ stacked_labels | default([]) | tojson }};
  const stackedDataRaw = {{ stacked_data | default([]) | tojson }};
  const stackedDatasets = stackedDataRaw.map((v, i) => ({
    label: v.label,
    data: v.data,
    backgroundColor: mainColors[i % mainColors.length]
  }));

  new Chart(document.getElementById('monthlyStackedBar'), {
    type: 'bar',
    data: {
      labels: stackedLabels,
      datasets: stackedDatasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            boxWidth: 24,
            font: { size: 12 },
            color: '#000',
            padding: 18
          }
        }
      },
      scales: {
        x: { stacked: true, title: { display: true, text: 'Month' } },
        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Project Count' } }
      }
    }
  });

  // Quarterly
  new Chart(document.getElementById('statusQuarterChart'), {
    type: 'bar',
    data: {
      labels: {{ quarter_labels|tojson }},
      datasets: [
        {
          label: 'Running',
          data: {{ quarter_data['Running']|tojson }},
          backgroundColor: '#b93495'
        },
        {
          label: 'Closed',
          data: {{ quarter_data['Closed']|tojson }},
          backgroundColor: '#8e24aa'
        },
        {
          label: 'Open',
          data: {{ quarter_data['Open']|tojson }},
          backgroundColor: '#3949ab'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { color: '#000', boxWidth: 24, font: { size: 14 }, padding: 18 } } },
      scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } }
    }
  });

  // Half-Yearly
  new Chart(document.getElementById('statusHalfChart'), {
    type: 'bar',
    data: {
      labels: {{ half_labels|tojson }},
      datasets: [
        {
          label: 'Running',
          data: {{ half_data['Running']|tojson }},
          backgroundColor: '#b93495'
        },
        {
          label: 'Closed',
          data: {{ half_data['Closed']|tojson }},
          backgroundColor: '#8e24aa'
        },
        {
          label: 'Open',
          data: {{ half_data['Open']|tojson }},
          backgroundColor: '#3949ab'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { color: '#000', boxWidth: 24, font: { size: 14 }, padding: 18 } } },
      scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } }
    }
  });

  // Yearly
  new Chart(document.getElementById('statusYearChart'), {
    type: 'bar',
    data: {
      labels: {{ year_labels_status|tojson }},
      datasets: [
        {
          label: 'Running',
          data: {{ year_data_status['Running']|tojson }},
          backgroundColor: '#b93495'
        },
        {
          label: 'Closed',
          data: {{ year_data_status['Closed']|tojson }},
          backgroundColor: '#8e24aa'
        },
        {
          label: 'Open',
          data: {{ year_data_status['Open']|tojson }},
          backgroundColor: '#3949ab'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { color: '#000', boxWidth: 24, font: { size: 14 }, padding: 18 } } },
      scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } }
    }
  });

  // Average Project Duration by Sanction Year (Bar Chart)
  const avgDurationLabels = {{ avg_duration_labels|tojson }};
  const avgDurationValues = {{ avg_duration_values|tojson }};
  // Assign colors from mainColors, cycling if there are more years than colors
  const avgDurationColors = avgDurationLabels.map((_, i) => mainColors[i % mainColors.length]);

  new Chart(document.getElementById('avgDurationChart'), {
    type: 'bar',
    data: {
      labels: avgDurationLabels,
      datasets: [{
        label: 'Avg Duration (days)',
        data: avgDurationValues,
        backgroundColor: avgDurationColors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Days' }
        },
        x: {
          title: { display: true, text: 'Sanction Year' }
        }
      }
    }
  });

  // Project Status Breakdown by Vertical (Stacked Bar)
  new Chart(document.getElementById('verticalStatusStacked'), {
    type: 'bar',
    data: {
      labels: {{ vertical_status_labels|tojson }},
      datasets: [
        {
          label: 'Running',
          data: {{ vertical_status_data['Running']|tojson }},
          backgroundColor: mainColors[0]
        },
        {
          label: 'Closed',
          data: {{ vertical_status_data['Closed']|tojson }},
          backgroundColor: mainColors[1]
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'bottom', labels: { color: '#000', boxWidth: 24, font: { size: 14 }, padding: 18 } } },
      scales: { x: { stacked: true }, y: { beginAtZero: true, stacked: true } }
    }
  });

  // Top PIs by Number of Projects (Horizontal Bar Chart)
  const topPIsLabels = {{ top_pis_labels | default([]) | tojson }};
  const topPIsValues = {{ top_pis_values | default([]) | tojson }};
  const topPIsColors = topPIsLabels.map((_, i) => mainColors[i % mainColors.length]);

  new Chart(document.getElementById('topPIsChart'), {
    type: 'bar',
    data: {
      labels: topPIsLabels,
      datasets: [{
        label: 'Number of Projects',
        data: topPIsValues,
        backgroundColor: topPIsColors
      }]
    },
    options: {
      indexAxis: 'y', // Horizontal bar chart
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: { display: true, text: 'Number of Projects' }
        },
        y: {
          title: { display: true, text: 'Principal Investigator' }
        }
      }
    }
  });

  // Top Institutes by Number of Projects (Horizontal Bar)
  const topInstituteLabels = {{ top_institute_labels|tojson }};
  const topInstituteValues = {{ top_institute_values|tojson }};
  const topInstituteColors = topInstituteLabels.map((_, i) => mainColors[i % mainColors.length]);

  new Chart(document.getElementById('topInstitutesBar'), {
    type: 'bar',
    data: {
      labels: topInstituteLabels,
      datasets: [{
        label: 'Projects',
        data: topInstituteValues,
        backgroundColor: topInstituteColors
      }]
    },
    options: {
      indexAxis: 'y', // horizontal bar
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { beginAtZero: true, title: { display: true, text: 'Number of Projects' } },
        y: { title: { display: true, text: 'Institute' } }
      }
    }
  });

  // Projects by Funding Range (Histogram)
  const fundingLabels = {{ funding_labels|tojson }};
  const fundingCounts = {{ funding_counts|tojson }};
  new Chart(document.getElementById('fundingRangeChart'), {
    type: 'bar',
    data: {
      labels: fundingLabels,
      datasets: [{
        label: 'Number of Projects',
        data: fundingCounts,
        backgroundColor: mainColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Project Count' }
        },
        x: {
          title: { display: true, text: 'Funding Range (Lakhs)' }
        }
      }
    }
  });

  // Projects by Stakeholder Lab (Pie Chart)
  const stakeholderLabLabels = {{ stakeholder_lab_labels|tojson }};
  const stakeholderLabValues = {{ stakeholder_lab_values|tojson }};
  const stakeholderLabColors = stakeholderLabLabels.map((_, i) => mainColors[i % mainColors.length]);

  new Chart(document.getElementById('stakeholderLabChart'), {
    type: 'pie',
    data: {
      labels: stakeholderLabLabels,
      datasets: [{
        data: stakeholderLabValues,
        backgroundColor: stakeholderLabColors,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 24, font: { size: 14 }, color: '#000', padding: 18 } }
      }
    }
  });

  // Administrative Status Trend (Line/Area Chart)
  const statusTrendLabels = {{ status_trend_labels|tojson }};
  const statusTrendDatasets = {{ status_trend_datasets|tojson }};
  statusTrendDatasets.forEach((ds, i) => {
    const hex = mainColors[i % mainColors.length];
    ds.borderColor = hex;
    ds.pointBackgroundColor = hex;
    // Convert hex to rgba with alpha 0.18 for semi-transparent fill
    ds.backgroundColor = hexToRgba(hex, 0.18);
    ds.fill = true;
  });

  // Helper function to convert hex to rgba
  function hexToRgba(hex, alpha) {
    let c = hex.replace('#', '');
    if (c.length === 3) c = c.split('').map(x => x + x).join('');
    const num = parseInt(c, 16);
    const r = (num >> 16) & 255;
    const g = (num >> 8) & 255;
    const b = num & 255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  new Chart(document.getElementById('adminStatusTrend'), {
    type: 'line',
    data: {
      labels: statusTrendLabels,
      datasets: statusTrendDatasets
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#000', // <-- add this line
            boxWidth: 24,
            font: { size: 14 },
            padding: 18
          }
        }
      },
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Sanctioned Cost Trend (Line Chart)
  const costTrendYearLabels = {{ cost_trend_year_labels|tojson }};
  const costTrendYearValues = {{ cost_trend_year_values|tojson }};

  new Chart(document.getElementById('costTrendYearChart'), {
    type: 'line',
    data: {
      labels: costTrendYearLabels,
      datasets: [{
        label: 'Total Sanctioned Cost (Lakhs)',
        data: costTrendYearValues,
        borderColor: "#5e35b1",
        backgroundColor: 'rgba(94, 53, 177, 0.18)',
        fill: true,
        tension: 0.3,
        pointRadius: 5,
        pointBackgroundColor: "#5e35b1"
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            color: '#000', // <-- add this line
            boxWidth: 24,
            font: { size: 14 },
            padding: 18
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Sanctioned Cost (Lakhs)' }
        },
        x: {
          title: { display: true, text: 'Year' }
        }
      }
    }
  });

document.dispatchEvent(new Event('analyticsChartsRendered'));
</script>

<!-- Button for filtered graph in Database page-->
{% if filtered %}
<div id="filteredDownloadBtnWrapper" style="text-align:left; margin-top: 1.5rem; margin-left: 87px;">
  <button id="downloadFilteredGraphsBtn" class="btn btn-secondary btn-md">Download Filtered Graphs</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.getElementById('downloadFilteredGraphsBtn').addEventListener('click', function() {
    // Select the section containing all your filtered charts
    const analyticsSection = document.querySelector('.chart-row').parentNode;
    html2canvas(analyticsSection, {backgroundColor: "#f8fbff", scale: 2}).then(canvas => {
        // Crop 60px from the bottom if needed
        const cropPx = 60;
        const croppedCanvas = document.createElement('canvas');
        croppedCanvas.width = canvas.width;
        croppedCanvas.height = canvas.height - cropPx;
        const ctx = croppedCanvas.getContext('2d');
        ctx.drawImage(canvas, 0, 0, canvas.width, canvas.height - cropPx, 0, 0, canvas.width, canvas.height - cropPx);

        const imgData = croppedCanvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'px',
            format: [croppedCanvas.width, croppedCanvas.height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, croppedCanvas.width, croppedCanvas.height, undefined, 'FAST');
        pdf.save('Filtered_Analytics_Graphs.pdf');
    });
});
</script>
{% endif %}